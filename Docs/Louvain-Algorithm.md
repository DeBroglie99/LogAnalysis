## Anomalies Detection and Proactive Defence of Routers Based on Multiple Information Learning 基于多信息学习的路由器异常检测与主动防御

### 背景

路由器是网络流量的传输中心，其上运行着诸如web服务，文件传输，域名解析，动态主机配置等很多服务。但与此同时，绝大多数用户不具备专业知识，无法正确配置路由器以保障其安全性，所以作为网络数据转发中心的路由器往往容易受到黑客攻击。如果攻击者设法攻击路由器，可能会获取到整个系统的数据控制权或者造成网络瘫痪。

以往的研究中提出了很多种路由器异常检测的方法：

- 通过监测分析流量变化趋势来进行异常检测，但并非所有路由器攻击都会导致流量变化

- 结合系统源代码进行分析，但在大多数情况下并不实用

- 纯日志分析：如Dlog从日志中提取模板；Deeplog从系统日志构建工作流程，并通过深度学习检测异常。但上述方案仅仅使用系统日志这一单一信息源，而事实表明，许多种路由器攻击不能从单一信息源中呈现出来，需要综合分析系统日志，防火墙日志，CPU利用率，LAN状态和内存信息

### 本文方案

本文中提出的路由器异常检测方案可以分为以下步骤：

##### 步骤一：离线学习（事件->日志）

在这一阶段，我们作为管理员在路由器上执行各种正常行为与恶意行为，并分别记录多种不同来源的日志信息，并对这些日志信息加以分析以获取用户行为与日志之间的关系。

##### 步骤二：异常检测（日志->行为）

收集路由器多源日志信息，并尝试在日志信息中识别事件，最后将攻击归为一个特定的集群，并告知用户攻击的具体类型。

##### 步骤三：在攻击发生之前预测攻击（日志->行为->攻击链）

仅仅检测异常还不够，我们需要在攻击发生之前做出预测。每当发现攻击后，立即追溯日志并找到攻击前的所有常规步骤，利用最长的公共子序列算法找出系统在受到攻击前呈现出的规律性步骤（称之为攻击链）并利用攻击链进行预测以达到主动防御的目的

<img src="pics/1.jpg" width=90%>

### 具体方案

##### 1.日志预处理

在进行路由器日志检测时，使用系统日志，CPU利用率，LAN状态，内存利用率四种不同来源的数据。首先要做的就是将系统日志进行预处理，使用正则表达式处理后从原始日志中提取出我们需要的日志模板

##### 2.特征向量化

- CPU利用率处理成一个7维向量：分别表示用户空间花费的CPU时间，内核空间花费的CPU时间，低优先级进程上花费的CPU时间，CPU空闲时间，磁盘上花费的CPU时间，用于服务处理或硬件中断花费的CPU时间，用于软件中断花费的CPU时间

- 内存利用率处理为6维向量，如下图所示

  <img src='pics/2.jpg' width=60%>

- LAN状态处理成6维向量：TX数据包发送，TX欠载，TX总线错误，RX数据包接收，RX溢出和RX总线错误（TX传输； RX接收）

- 系统日志是文本形式的，向量化较为复杂，这里主要参考了Dlog的处理方式并为日志序列指定了许多功能，例如IP数量，持续时间，严重性级别等。最终形成17维向量。

##### 3.聚类

初始向量维数过高，不能直接用于计算，需要先使用PCA等方法降维。

原论文指出，基于历史的学习方法固然能学习一些已知的攻击并将其分类，但是对于一些新的攻击，其学习效果并不好。因此本文使用了一种基于日志相关性的聚类方法——Louvain社区发现算法。

以下只是个人见解，因原文表述较简略，且个人功力有限，恐有误读：

- 社区的含义有些类似于聚类。Louvain算法是基于模块度的聚类算法，通过模块度这个概念来衡量一个社区的紧密程度。

- 模块度定义如下：社区内节点的连边数与随机情况下的边数之差
  $$
  Q=\frac{1}{2m} \times \sum_{i,j} [A_{ij}-\frac{k_i k_j}{2m}]\delta(c_i,c_j)
  $$
  其中$A_{ij}$:节点$i$和节点$j$之间边的权重，$k_i$:所有与节点$i$相连的边的权重之和，$c_i$:节点=$i$所属社区

  $m$：图中所有边权重之和  $m=\frac{1}{2}\sum_{i,j}A_{ij}​$（这里原论文所述有误）

- Louvain算法思想：

  - 1）将图中的每个节点看成一个独立的社区，次数社区的数目与节点个数相同；
  - 2）对每个节点$i$，依次尝试把节点$i$分配到其每个邻居节点所在的社区，计算分配前与分配后的模块度变化$ΔQ$，并记录$ΔQ$最大的那个邻居节点，如果$maxΔQ>0$，则把节点i分配$ΔQ$最大的那个邻居节点所在的社区，否则保持不变；
  - 3）重复2），直到所有节点的所属社区不再变化；
  - 4）对图进行压缩，将所有在同一个社区的节点压缩成一个新节点，社区内节点之间的边的权重转化为新节点的环的权重，社区间的边权重转化为新节点间的边权重；
  - 5）重复1）直到整个图的模块度不再发生变化。

- 图中边的权重由如下公式给出：

  <img src="pics/3.jpg" width=70%>

  其中$\alpha_{i}$为权重向量，$e$为边向量，$e_A$为异常日志集合内部边向量，$e_B$为正常日志集合内部边向量，$e_{AB}$为集合$AB$之间的边向量，$k​$为向量维数。但上述公式疑似有误??(因为A B不对称)

##### 4.异常检测

对于每一个聚类（社区），计算：

- 聚类中心$C_{mn}$:$k-means$算法中所有点坐标均值
- $C_{md}$：$k-medoids$算法中的代表点

并将聚类k中的点表示为集合$N^k$，设所有点具有相同维度$v$，则两个点之间距离为
$$
d(N_i^{k},N_j^{k})=\sqrt{(I_{i1}^k-I_{j1}^k)^2+(I_{i2}^k-I_{j2}^k)^2+...+(I_{iv}^k-I_{jv}^k)^2}
$$
分别计算$C_{mn}$与$C_{md}$对应的聚类半径，并选取而这种较大的那个作为最终的阈值

<img src="pics/4.jpg" width=50%>

进行异常检测时，获得输入点$N_x$,将其聚类到最近的社区，然后计算到两个中心的距离，我们选择最小的那个作为与阈值进行比较的距离，如果距离大于阈值，则其不可能为正常事件。若小于，将其归为学习事件。

检测到攻击后，我们将其与学习到的攻击模式进行匹配。如果攻击可以与模板匹配，我们可以告诉用户攻击属于哪种类型。然后，我们可以为攻击推荐相应的解决方案和补丁。但是，如果攻击不在群集集中，则应将其发送给适当的专家以进行后续验证。如果专家确认了相应的攻击并可以提供解决方案，我们会将结果返回到训练过程中，从而可以逐步提高异常检测的准确性。

##### 5.攻击预测

攻击预测的大体思路是追踪攻击日志之前的几条日志。这些日志有的可能是正常操作（如在破解路由器密码后登录），有的则可能是攻击的关键步骤。我们通过LCS算法（最长公共子序列）来寻找两次攻击前的相同步骤。这一部分与和诺基亚合作的项目似无太大关联。